<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: /home/zoe/Mbed Programs/esp_code/mbed-os/drivers/usb/tests/TESTS/usb_device Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_17da55b82df43ed6ea98ba2fd34631c8.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">usb_device Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_fee28aad6cf1bf5ddaeb28ddfaf8480e.html">basic</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_5a694c1277fdbc2f4cc69aa21786e6c4.html">hid</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_7477f94c33dd04ea510c250a4bd1cdb8.html">msd</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_273fc246c023538d14d3d68fa26d0204.html">serial</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="autotoc_md652"></a>
Setup</h1>
<p>Before running tests, please make sure to use a <a href="../../requirements.txt">top-level requirements.txt</a> file to install all the required Python modules.</p>
<div class="fragment"><div class="line">pip install -r requirements.txt</div>
</div><!-- fragment --><p>Additional, platform-specific setup is described below. See also Known issues.</p>
<h2><a class="anchor" id="autotoc_md653"></a>
Windows</h2>
<ol type="1">
<li>Install a <b>generic USB driver</b> for two test devices.<ol type="a">
<li>Download <code>Zadig</code> application from <a href="https://zadig.akeo.ie/">the Zadig website</a>.</li>
</ol>
<ol type="a">
<li>Unplug the Mbed device.</li>
</ol>
<ol type="a">
<li>Open <code>Zadig</code>.</li>
</ol>
<ol type="a">
<li>Select <em>Device -&gt; Load Preset Device</em>.</li>
</ol>
<ol type="a">
<li>Open <a href="basic/zadig_conf/mbed_os-usb_test_device1.cfg">TESTS/usb_device/basic/zadig_conf/mbed_os-usb_test_device1.cfg</a></li>
</ol>
<ol type="a">
<li>Choose <code>libusb-win32 (v1.2.6.0)</code> driver.</li>
</ol>
<ol type="a">
<li>Select <code>Install Driver</code> and click it.</li>
</ol>
<ol type="a">
<li>Select <em>Device -&gt; Load Preset Device</em>.</li>
</ol>
<ol type="a">
<li>Open <a href="basic/zadig_conf/mbed_os-usb_test_device2.cfg">TESTS/usb_device/basic/zadig_conf/mbed_os-usb_test_device2.cfg</a></li>
</ol>
<ol type="a">
<li>Choose <code>libusb-win32 (v1.2.6.0)</code> driver.</li>
</ol>
<ol type="a">
<li>Select <code>Install Driver</code> and click it.</li>
</ol>
<ol type="a">
<li>Close <code>Zadig</code>.</li>
</ol>
<ol type="a">
<li>Plug both USB interfaces (<em>DAPLink</em> and <em>USB device</em>).</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md654"></a>
Linux</h2>
<ol type="1">
<li><p class="startli">Install the <code>hidapi</code> Python module, otherwise some USB HID test cases will be skipped. This module is not installed during the initial setup due to external dependencies for Linux.</p>
<p class="startli">For Debian-based Linux distros, the dependencies can be installed as follows (based on module's <a href="https://github.com/trezor/cython-hidapi/blob/master/README.rst#install">README</a>):</p>
<p class="startli"><code>bash apt-get install python-dev libusb-1.0-0-dev libudev-dev pip install --upgrade setuptools </code></p>
<p class="startli">To install the <code>hidapi</code> module itself, please use the attached <a href="hid/requirements.txt">requirements.txt</a> file:</p>
<p class="startli"><code>bash pip install -r TESTS/usb_device/hid/requirements.txt </code></p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Update the <code>udev</code> rules for Mbed USB CDC device as follows (<a href="https://linux-tips.com/t/prevent-modem-manager-to-capture-usb-serial-devices/284">source</a>):</p>
<p class="startli"><code>bash sudo tee /etc/udev/rules.d/99-ttyacms.rules &gt;/dev/null &lt;&lt;EOF ATTRS{idVendor}=="1f00" ATTRS{idProduct}=="2013", ENV{ID_MM_DEVICE_IGNORE}="1" ATTRS{idVendor}=="1f00" ATTRS{idProduct}=="2012", ENV{ID_MM_DEVICE_IGNORE}="1" EOF sudo udevadm control --reload-rules </code></p>
<p class="startli">This will prevent the <code>ModemManager</code> daemon from automatically opening the port and sending the <code>AT commands</code>, which it does for every new <code>/dev/ttyACM</code> device registered in system.</p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md655"></a>
Mac</h2>
<p>No setup method has been verified for this platform.</p>
<h1><a class="anchor" id="autotoc_md656"></a>
Running tests</h1>
<ol type="1">
<li>Plug both USB interfaces (<em>DAPLink</em> and <em>USB device</em>) to your host machine.</li>
</ol>
<ol type="1">
<li>An additional macro <code>USB_DEVICE_TESTS</code> is needed to be defined when running tests: <div class="fragment"><div class="line">mbed test -t &lt;toolchain&gt; -m &lt;target&gt; -DUSB_DEVICE_TESTS -n *-tests-usb_device-*</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md657"></a>
Known issues</h1>
<h2><a class="anchor" id="autotoc_md658"></a>
Insufficient user permissions on a Linux machine</h2>
<p>Some of the tests require privileged access to the USB device. Running these as an unprivileged user will manifest with either of the following errors:</p><ul>
<li><code> [HTST][INF] Device not found </code></li>
<li><code> [HTST][INF] TEST ERROR: Failed with "The device has no langid". Tried 20 times. </code></li>
</ul>
<h3><a class="anchor" id="autotoc_md659"></a>
Solution</h3>
<p>Execute tests with elevated permissions using <code>sudo</code>: </p><div class="fragment"><div class="line">mbed test -t &lt;toolchain&gt; -m &lt;target&gt; -DUSB_DEVICE_TESTS -n tests-usb_device-* --compile</div>
<div class="line">sudo mbed test -t &lt;toolchain&gt; -m &lt;target&gt; -n *-tests-usb_device-* --run -v</div>
</div><!-- fragment --><p> Note only the <code>mbed test --run</code> command requires <code>sudo</code>. You can still <code>mbed test --compile</code> as a normal user.</p>
<h3><a class="anchor" id="autotoc_md660"></a>
Alternative solution</h3>
<p>Add an <code>udev</code> rule to set the ownership of the device node <a href="https://stackoverflow.com/questions/3738173/why-does-pyusb-libusb-require-root-sudo-permissions-on-linux/8582398#8582398">as shown here</a>.</p>
<h2><a class="anchor" id="autotoc_md661"></a>
Data toggle reset test fails on a Linux machine</h2>
<p>The <code>tests-usb_device-basic</code> / <code>"endpoint test data toggle reset"</code> test fails with the following error: </p><div class="fragment"><div class="line">[HTST][INF] TEST FAILED: Data toggle not reset when calling</div>
<div class="line">ClearFeature(ENDPOINT_HALT) on an endpoint that has not been halted.</div>
</div><!-- fragment --><p>Implementations of the <em>xHCI</em> driver prior to version 4.17 of the Linux kernel did not have the functionality necessary to test <code>"endpoint test data toggle reset"</code>. Even though the data toggle is correctly reset on the device side, the host side will not be synchronized and the test will falsely fail.</p>
<h3><a class="anchor" id="autotoc_md662"></a>
Solution</h3>
<p>Make sure that <b>at least one</b> of the following prerequisites is met:</p><ul>
<li>using the Linux kernel <em><b>4.17* or newer**,</b></em></li>
<li><em><b>using the ***eHCI</b></em> USB driver instead of <em>xHCI</em>.</li>
</ul>
<p>Changing the USB driver may be as simple as updating one of the BIOS settings on your machine. If you'd rather avoid rebooting, you can try <a href="https://linuxmusicians.com/viewtopic.php?t=16901">using setpci command</a>.</p>
<h3><a class="anchor" id="autotoc_md663"></a>
Further reading</h3>
<ol type="1">
<li><a href="https://github.com/torvalds/linux/commit/f5249461b504d35aa1a40140983b7ec415807d9e">the Linux kernel patch adding missing xHCI behavior</a>,</li>
</ol>
<ol type="1">
<li><a href="https://lkml.org/lkml/2016/12/15/388">LKML discussion explaining the details of this issue</a>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md664"></a>
Mass storage tests are skipped on some targets</h2>
<p>The <code>tests-usb_device-msd</code> test outputs the following message: </p><div class="fragment"><div class="line">[CONN][RXD] SKIP: Not enough heap memory for HeapBlockDevice creation</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md665"></a>
Solution</h3>
<p>A device with at least <em>70 kB</em> of RAM is required to run this test. The FAT32 filesystem cannot be mounted on a device smaller than 64 kB.</p>
<p>The test can be easily extended to use any block device available in Mbed.</p>
<h2><a class="anchor" id="autotoc_md666"></a>
Windows 8/10: Mass storage tests are failing on test file read</h2>
<p>By default Windows 8 and 10 access and write to removable drives shortly after they are connected. It's caused by drive indexing mechanisms. Because disk used in test has only 64kB its content can be easily corrupted by writing large files, what actually was encountered during test runs.</p>
<p>To prevent Windows from writing to removable drives on connect drive indexing can be turned off with the following procedure:</p><ul>
<li>Start the program "gpedit.msc"</li>
<li>Navigate to "Computer Configuration \ Administrative Templates \ Windows Components \ Search"</li>
<li>Enable the policy "Do not allow locations on removable drives to be added to  libraries."</li>
</ul>
<h2><a class="anchor" id="autotoc_md667"></a>
Isochronous endpoints are skipped in loopback tests</h2>
<h3><a class="anchor" id="autotoc_md668"></a>
Unresolved</h3>
<h2><a class="anchor" id="autotoc_md669"></a>
Serial tests fail intermittently on a Linux machine</h2>
<h3><a class="anchor" id="autotoc_md670"></a>
Unresolved</h3>
<p>You may want to connect the device directly to the host machine with no hubs on the way. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5fdebfbd0a4b5643a5e85bf3c8b1558b.html">mbed-os</a></li><li class="navelem"><a class="el" href="dir_f1b16baafcc1697607aba4d4d51e2eb7.html">drivers</a></li><li class="navelem"><a class="el" href="dir_cf60a1241b9868bfc79e655b1a5055d5.html">usb</a></li><li class="navelem"><a class="el" href="dir_ffff33a2003a5fd23320c5245cf94735.html">tests</a></li><li class="navelem"><a class="el" href="dir_b45cf9b4d1a65dfe0545a419824d0479.html">TESTS</a></li><li class="navelem"><a class="el" href="dir_17da55b82df43ed6ea98ba2fd34631c8.html">usb_device</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
