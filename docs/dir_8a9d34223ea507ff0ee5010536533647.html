<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: /home/zoe/Mbed Programs/esp_code/mbed-os/connectivity/drivers/emac Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_8a9d34223ea507ff0ee5010536533647.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">emac Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_b57535f685c99fc030fd1b97c03819cb.html">TARGET_Freescale_EMAC</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_b384658365fd634ad7b892fe43da84d0.html">TARGET_GD_EMAC</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_088300282ce285043e44850e9037bc1c.html">TARGET_NUVOTON_EMAC</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_4186f9e640f56895cafc9165baa8d458.html">TARGET_RDA_EMAC</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_4e8697eb0d78cb7e095cb38818e623b2.html">TARGET_Silicon_Labs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_ecf92137f00fdf485b7c5a07541511eb.html">TARGET_STM</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>This document describes how to port and test an Ethernet MAC (<a class="el" href="classEMAC.html">EMAC</a>) driver to mbed OS. It is based on work on the feature-emac branch as of mbed OS 5.8, which is intended to be merged into mbed OS 5.9</p>
<p>The scope of this document is limited to Ethernet (IEEE 802.3) or Ethernet-like devices such as Wi-Fi (IEEE 802.11), where the device presents a MAC interface to send and receive frames, and this will be used by one of the onboard network stacks that runs on mbed OS on the host processor.</p>
<p>(If the device has an off-board network stack, a driver would need to implement <code><a class="el" href="classNetworkStack.html">NetworkStack</a></code> directly instead to pass network calls to that offboard stack).</p>
<h1><a class="anchor" id="autotoc_md115"></a>
Abstractions</h1>
<p>The <a class="el" href="classEMAC.html">EMAC</a> interface is designed to abstract network stacks and drivers, and to easily permit multiple instances. The key API classes are:</p>
<ul>
<li><code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> - an mbed OS network interface of any type</li>
<li><code><a class="el" href="classNetworkStack.html">NetworkStack</a></code> - an mbed OS network stack of any type (may be off-board)</li>
<li><code><a class="el" href="classOnboardNetworkStack.html">OnboardNetworkStack</a></code> - an on-board network stack</li>
<li><code><a class="el" href="classEMAC.html">EMAC</a></code> - an Ethernet MAC device driver</li>
<li><code><a class="el" href="classEMACMemoryManager.html">EMACMemoryManager</a></code> - a memory manager used to pass data between driver and stack</li>
<li><code><a class="el" href="classEMACInterface.html">EMACInterface</a></code>- a <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> that uses an <code><a class="el" href="classEMAC.html">EMAC</a></code> driver and an <code><a class="el" href="classOnboardNetworkStack.html">OnboardNetworkStack</a></code></li>
</ul>
<h1><a class="anchor" id="autotoc_md116"></a>
The EMAC driver core</h1>
<p>The first step in the port is to create a driver class that can be instantiated to control your device. This must be derived from class <code><a class="el" href="classEMAC.html">EMAC</a></code>. This API is used by a network stack (or test framework) to control your driver.</p>
<p>The EMAC-derived driver would normally be installed in connectivity/drivers/emac, often in a <code>TARGET_XXX</code> directory.</p>
<p>Class <a class="el" href="classEMAC.html">EMAC</a> is entirely abstract - you need to implement about a dozen calls to activate the driver, send and receive packets, and perform other control and information functions.</p>
<p>There are also callback registration functions for upcalls from the driver - the stack can register callback functions for packet reception and link status changes.</p>
<h1><a class="anchor" id="autotoc_md117"></a>
The EMAC memory manager</h1>
<p>For the send and receive paths, data is transferred in memory buffers controlled via an <code><a class="el" href="classEMACMemoryManager.html">EMACMemoryManager</a></code> object. The network stack using an <a class="el" href="classEMAC.html">EMAC</a> driver provides it with a reference to the memory manager in use before powering up - this will be constant as long as the <a class="el" href="classEMAC.html">EMAC</a> is powered up.</p>
<p>On the output call, the <a class="el" href="classEMAC.html">EMAC</a> driver is given ownership of a buffer chain - it must free the chain when it has finished with the data. The data may or may not be contiguous. A driver can express alignment preferences for outgoing data, but the network stack is not required to meet these prefernces, so a driver relying on alignment may need a slow path that copies data into an aligned (or contiguous) buffer.</p>
<p>For reception, the <a class="el" href="classEMAC.html">EMAC</a> driver must allocate memory from the <code><a class="el" href="classEMACMemoryManager.html">EMACMemoryManager</a></code> to store the received packets - this is then passed to the link input callback, which will free it. By preference this memory should be allocated using the pool, but if contiguous memory is required it can be allocated from the heap.</p>
<h1><a class="anchor" id="autotoc_md118"></a>
EthernetInterface</h1>
<p>If your driver is a pure Ethernet driver, there is no further implementation required. The class <code><a class="el" href="classEthernetInterface.html">EthernetInterface</a></code> can use any <code><a class="el" href="classEMAC.html">EMAC</a></code> driver to provide an mbed OS <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code>: </p><pre class="fragment">MyEMAC my_emac(params);
EthernetInterface net(&amp;my_emac);

net.connect();
</pre><p>This will attach the default network stack (normally lwIP - the other current alternative is <a class="el" href="classNanostack.html">Nanostack</a>) to the specified <a class="el" href="classEMAC.html">EMAC</a> driver, and provide all the generic <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> and <code><a class="el" href="classNetworkStack.html">NetworkStack</a></code> APIs.</p>
<h1><a class="anchor" id="autotoc_md119"></a>
Being the default EMAC / EthernetInterface</h1>
<p>To make your <a class="el" href="classEMAC.html">EMAC</a> the default for applications you should define the static function <code><a class="el" href="group__lwip17xx__emac__DRIVER.html#gacc0729725206050054ec718080a07f1b">EMAC::get_default_instance()</a></code> to return an instance of your emac, eg: </p><pre class="fragment">MBED_WEAK EMAC &amp;EMAC::get_default_instance()
{
    static MyEMAC my_emac(params);
    return &amp;my_emac;
}
</pre><p>This permits this example application code to work: </p><pre class="fragment">EthernetInterface net;  // uses EMAC::get_default_instance()
net.connect();
</pre><p>This definition would normally be gated by a target label of some sort. As target code, your definition of <a class="el" href="group__lwip17xx__emac__DRIVER.html#gacc0729725206050054ec718080a07f1b">EMAC::get_default_instance()</a> must be weak - this permits it to be overridden by application code.</p>
<h1><a class="anchor" id="autotoc_md120"></a>
Wi-Fi interfaces</h1>
<p>As a Wi-Fi interface, a little more work is required - at a minimum you need to implement the extra configuration calls in <code><a class="el" href="classWiFiInterface.html">WiFiInterface</a></code>. This is because the network stacks and <a class="el" href="classEMAC.html">EMAC</a> APIs are only related to the Ethernet-like data path - they have no knowledge of any other configuration mechanisms and assume they are already set up.</p>
<p>To do this, you should create a C++ class that inherits from both <code><a class="el" href="classWiFiInterface.html">WiFiInterface</a></code> and <code><a class="el" href="classEMACInterface.html">EMACInterface</a></code>. The <code><a class="el" href="classEMACInterface.html">EMACInterface</a></code> is a helper class that implements all the core <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> functionality for you. You then just need to implement the extra <code><a class="el" href="classWiFiInterface.html">WiFiInterface</a></code> configuration methods.</p>
<p>For reference, note that <code><a class="el" href="classEthernetInterface.html">EthernetInterface</a></code> also derives from <code><a class="el" href="classEMACInterface.html">EMACInterface</a></code>, but has no extra code as there is no extra configuration required.</p>
<p>As a Wi-fi driver, you will not normally be directly exposing your <code><a class="el" href="classEMAC.html">EMAC</a></code> class - it would not normally be declared as <code><a class="el" href="group__lwip17xx__emac__DRIVER.html#gacc0729725206050054ec718080a07f1b">EMAC::get_default_instance</a></code>, but you would pass it to the constructor of your base <code><a class="el" href="classEMACInterface.html">EMACInterface</a></code>. This then will make it visible via the <code>get_emac</code> method. This is for test purposes, meaning the test framework can do: </p><pre class="fragment">MyWiFiInterface net;
net.set_credentials();
EMAC &amp;emac = net.get_emac();
do_emac_test(emac);
</pre><p>This must work in your driver - it must be possible to power up and use the built-in <a class="el" href="classEMAC.html">EMAC</a> directly without the <code><a class="el" href="classNetworkInterface.html#aa7ef54ecbd066f2083e6031bd1f3cb00">NetworkInterface::connect()</a></code> method being invoked, as long as the credentials have been set. This structure will come naturally if you just use the default <code><a class="el" href="classEMACInterface.html#abf11adb7c47186537cf1c7c72f6cece5">EMACInterface::connect()</a></code> implementation.</p>
<p>Note also that your constructor must allow the network stack to be specified using the same form as <code><a class="el" href="classEthernetInterface.html">EthernetInterface</a></code>: </p><pre class="fragment">MyWiFiInterface(OnboardNetworkStack &amp;stack = OnboardNetworkStack::get_default_instance());
</pre><h1><a class="anchor" id="autotoc_md121"></a>
OnboardNetworkStack</h1>
<p>The precise details of the <code><a class="el" href="classOnboardNetworkStack.html">OnboardNetworkStack</a></code> API should not concern an <a class="el" href="classEMAC.html">EMAC</a> driver writer - it provides the mechanism to bind a driver to a stack, and the APIs needed to implement a <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code>, but this is handled by <code><a class="el" href="classEMACInterface.html">EMACInterface</a></code>, either as a base class of your own <code>XXXInterface</code> or as the base of <code><a class="el" href="classEthernetInterface.html">EthernetInterface</a></code>.</p>
<h1><a class="anchor" id="autotoc_md122"></a>
DEVICE_EMAC</h1>
<p>At present, as an interim measure, targets providing <code><a class="el" href="group__lwip17xx__emac__DRIVER.html#gacc0729725206050054ec718080a07f1b">EMAC::get_default_instance()</a></code> should add "EMAC" in <code>device_has</code> in their <code>targets.json</code>. This activates network tests in CI builds.</p>
<p>This is subject to change, but is necessary in lieu of the previous typical behaviour of gating tests on <code>FEATURE_LWIP</code>.</p>
<h1><a class="anchor" id="autotoc_md123"></a>
Tuning memory allocations</h1>
<p>Depending on its use of pool and heap memory, and other factors, a driver might want to tune the configuration of particular network stacks. This can be done via the <code>mbed_lib.json</code> of each network stack, using their <code>target_overrides</code> section.</p>
<h1><a class="anchor" id="autotoc_md124"></a>
Testing</h1>
<p>The mbed OS tree contains Greentea-based tests that exercise the <a class="el" href="classEMAC.html">EMAC</a> API directly, and more general socket tests.</p>
<p>See here for general Greentea information: <a href="https://github.com/ARMmbed/greentea">https://github.com/ARMmbed/greentea</a></p>
<p>See here for the emac tests: <a href="https://github.com/ARMmbed/mbed-os/tree/feature-emac/TESTS/network/emac">https://github.com/ARMmbed/mbed-os/tree/feature-emac/TESTS/network/emac</a></p>
<p>Greentea socket tests are at: <a href="https://github.com/ARMmbed/mbed-os/tree/feature-emac/TESTS/netsocket">https://github.com/ARMmbed/mbed-os/tree/feature-emac/TESTS/netsocket</a></p>
<p>The driver should also be exercised with real-world examples like <a href="https://github.com/ARMmbed/mbed-os-example-client">https://github.com/ARMmbed/mbed-os-example-client</a></p>
<p>The driver should also be tested with both network stacks available in mbed OS, as they will use the driver somewhat differently - try with the JSON option <code>nsapi.default-stack</code> set to each of <code><a class="el" href="classLWIP.html">LWIP</a></code> and <code>NANOSTACK</code>.</p>
<p><a class="el" href="classNanostack.html">Nanostack</a> is IPv6 only. IPv6 operation should also be tested with lwIP, as this is likely to reveal problems with multicast filtering that may not be spotted by IPv4 or <a class="el" href="classNanostack.html">Nanostack</a>. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5fdebfbd0a4b5643a5e85bf3c8b1558b.html">mbed-os</a></li><li class="navelem"><a class="el" href="dir_456207283565120b441ff9733579e7b8.html">connectivity</a></li><li class="navelem"><a class="el" href="dir_59977a0c207738c890dea4a1d368376e.html">drivers</a></li><li class="navelem"><a class="el" href="dir_8a9d34223ea507ff0ee5010536533647.html">emac</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
