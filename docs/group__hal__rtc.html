<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: RTC hal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('group__hal__rtc.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Topics</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">RTC hal<div class="ingroups"><a class="el" href="group__hal.html">Hal</a></div></div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="groups" name="groups"></a>
Topics</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__hal__rtc__tests.html">RTC hal tests</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gacf9024748b942a7ae375cf75951afa9c" id="r_gacf9024748b942a7ae375cf75951afa9c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a> (void)</td></tr>
<tr class="separator:gacf9024748b942a7ae375cf75951afa9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaff89a06474197687978319e11ccfbd8a" id="r_gaff89a06474197687978319e11ccfbd8a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gaff89a06474197687978319e11ccfbd8a">rtc_free</a> (void)</td></tr>
<tr class="separator:gaff89a06474197687978319e11ccfbd8a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8d49d48e7cc7804e34305a99f34aa450" id="r_ga8d49d48e7cc7804e34305a99f34aa450"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga8d49d48e7cc7804e34305a99f34aa450">rtc_isenabled</a> (void)</td></tr>
<tr class="separator:ga8d49d48e7cc7804e34305a99f34aa450"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8c6e23c64ed14aa23f4d524720350228" id="r_ga8c6e23c64ed14aa23f4d524720350228"><td class="memItemLeft" align="right" valign="top">time_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga8c6e23c64ed14aa23f4d524720350228">rtc_read</a> (void)</td></tr>
<tr class="separator:ga8c6e23c64ed14aa23f4d524720350228"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa3c98f2c275d1ecbafcdba6b6c6032e7" id="r_gaa3c98f2c275d1ecbafcdba6b6c6032e7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gaa3c98f2c275d1ecbafcdba6b6c6032e7">rtc_write</a> (time_t t)</td></tr>
<tr class="separator:gaa3c98f2c275d1ecbafcdba6b6c6032e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The RTC hal provides a low level interface to the Real Time Counter (RTC) of a target.</p>
<h1><a class="anchor" id="autotoc_md754"></a>
Defined behaviour</h1>
<ul>
<li>The function <a class="el" href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a> is safe to call repeatedly - Verified by test ::rtc_init_test.</li>
<li>RTC accuracy is at least 10% - Verified by test ::rtc_accuracy_test.</li>
<li>Init/free doesn't stop RTC from counting - Verified by test ::rtc_persist_test.</li>
<li>Software reset doesn't stop RTC from counting - Verified by test ::rtc_reset_test.</li>
<li>Sleep modes don't stop RTC from counting - Verified by test ::rtc_sleep_test.</li>
<li>Shutdown mode doesn't stop RTC from counting - Not verified.</li>
<li>The functions <a class="el" href="#gaa3c98f2c275d1ecbafcdba6b6c6032e7">rtc_write</a>/<a class="el" href="#ga8c6e23c64ed14aa23f4d524720350228">rtc_read</a> provides availability to set/get RTC time</li>
<li>Verified by test ::rtc_write_read_test.</li>
<li>The functions <a class="el" href="#ga8d49d48e7cc7804e34305a99f34aa450">rtc_isenabled</a> returns 1 if the RTC is counting and the time has been set, 0 otherwise - Verified by test ::rtc_enabled_test.</li>
</ul>
<h1><a class="anchor" id="autotoc_md755"></a>
Undefined behaviour</h1>
<ul>
<li>Calling any function other than <a class="el" href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a> before the initialisation of the RTC</li>
</ul>
<h1><a class="anchor" id="autotoc_md756"></a>
Potential bugs</h1>
<ul>
<li>Incorrect overflow handling - Verified by ::rtc_range_test</li>
<li>Glitches due to ripple counter - Verified by ::rtc_glitch_test</li>
</ul>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__hal__rtc__tests.html">RTC hal tests</a> </dd></dl>
<h2 class="groupheader">Function Documentation</h2>
<a id="gaff89a06474197687978319e11ccfbd8a" name="gaff89a06474197687978319e11ccfbd8a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaff89a06474197687978319e11ccfbd8a">&#9670;&#160;</a></span>rtc_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtc_free </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Deinitialize RTC</p>
<p>Powerdown the RTC in preparation for sleep, powerdown or reset. That should only affect the CPU domain and not the time keeping logic. After this function is called no other RTC functions should be called except for <a class="el" href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a>.</p>
<dl class="section note"><dt>Note</dt><dd>This function does not stop the RTC from counting - Tested by ::rtc_persist_test</dd></dl>
<p>Example Implementation Pseudo Code: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="#gaff89a06474197687978319e11ccfbd8a">rtc_free</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Disable clock gate since processor no longer needs to read RTC registers</span></div>
<div class="line">    POWER_CTRL &amp;= ~POWER_CTRL_RTC_Msk;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal__rtc_html_gaff89a06474197687978319e11ccfbd8a"><div class="ttname"><a href="#gaff89a06474197687978319e11ccfbd8a">rtc_free</a></div><div class="ttdeci">void rtc_free(void)</div></div>
</div><!-- fragment --> 
</div>
</div>
<a id="gacf9024748b942a7ae375cf75951afa9c" name="gacf9024748b942a7ae375cf75951afa9c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gacf9024748b942a7ae375cf75951afa9c">&#9670;&#160;</a></span>rtc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtc_init </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initialize the RTC peripheral</p>
<p>Powerup the RTC in perpetration for access. This function must be called before any other RTC functions ares called. This does not change the state of the RTC. It just enables access to it.</p>
<dl class="section note"><dt>Note</dt><dd>This function is safe to call repeatedly - Tested by ::rtc_init_test</dd></dl>
<p>Example Implementation Pseudo Code: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Enable clock gate so processor can read RTC registers</span></div>
<div class="line">    POWER_CTRL |= POWER_CTRL_RTC_Msk;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// See if the RTC is already setup</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(RTC_STATUS &amp; RTC_STATUS_COUNTING_Msk)) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Setup the RTC clock source</span></div>
<div class="line">        RTC_CTRL |= RTC_CTRL_CLK32_Msk;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal__rtc_html_gacf9024748b942a7ae375cf75951afa9c"><div class="ttname"><a href="#gacf9024748b942a7ae375cf75951afa9c">rtc_init</a></div><div class="ttdeci">void rtc_init(void)</div></div>
</div><!-- fragment --> 
</div>
</div>
<a id="ga8d49d48e7cc7804e34305a99f34aa450" name="ga8d49d48e7cc7804e34305a99f34aa450"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8d49d48e7cc7804e34305a99f34aa450">&#9670;&#160;</a></span>rtc_isenabled()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int rtc_isenabled </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Check if the RTC has the time set and is counting</p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>The time reported by the RTC is not valid </td></tr>
    <tr><td class="paramname">1</td><td>The time has been set the RTC is counting</td></tr>
  </table>
  </dd>
</dl>
<p>Example Implementation Pseudo Code: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="#ga8d49d48e7cc7804e34305a99f34aa450">rtc_isenabled</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (RTC_STATUS &amp; RTC_STATUS_COUNTING_Msk) {</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal__rtc_html_ga8d49d48e7cc7804e34305a99f34aa450"><div class="ttname"><a href="#ga8d49d48e7cc7804e34305a99f34aa450">rtc_isenabled</a></div><div class="ttdeci">int rtc_isenabled(void)</div></div>
</div><!-- fragment --> 
</div>
</div>
<a id="ga8c6e23c64ed14aa23f4d524720350228" name="ga8c6e23c64ed14aa23f4d524720350228"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga8c6e23c64ed14aa23f4d524720350228">&#9670;&#160;</a></span>rtc_read()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">time_t rtc_read </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get the current time from the RTC peripheral</p>
<dl class="section return"><dt>Returns</dt><dd>The current time in seconds</dd></dl>
<dl class="section note"><dt>Note</dt><dd>Some RTCs are not synchronized with the main clock. If this is the case with your RTC then you must read the RTC time in a loop to prevent reading the wrong time due to a glitch. The test ::rtc_glitch_test is intended to catch this bug.</dd></dl>
<p>Example implementation for an unsynchronized ripple counter: </p><div class="fragment"><div class="line">time_t <a class="code hl_function" href="#ga8c6e23c64ed14aa23f4d524720350228">rtc_read</a>()</div>
<div class="line">{</div>
<div class="line">    uint32_t val;</div>
<div class="line">    uint32_t last_val;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Loop until the same value is read twice</span></div>
<div class="line">    val = RTC_SECONDS;</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        last_val = val;</div>
<div class="line">        val = RTC_SECONDS;</div>
<div class="line">    } <span class="keywordflow">while</span> (last_val != val);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (time_t)val;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal__rtc_html_ga8c6e23c64ed14aa23f4d524720350228"><div class="ttname"><a href="#ga8c6e23c64ed14aa23f4d524720350228">rtc_read</a></div><div class="ttdeci">time_t rtc_read(void)</div></div>
</div><!-- fragment --> 
</div>
</div>
<a id="gaa3c98f2c275d1ecbafcdba6b6c6032e7" name="gaa3c98f2c275d1ecbafcdba6b6c6032e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa3c98f2c275d1ecbafcdba6b6c6032e7">&#9670;&#160;</a></span>rtc_write()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rtc_write </td>
          <td>(</td>
          <td class="paramtype">time_t</td>          <td class="paramname"><span class="paramname"><em>t</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Write the current time in seconds to the RTC peripheral</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">t</td><td>The current time to be set in seconds.</td></tr>
  </table>
  </dd>
</dl>
<p>Example Implementation Pseudo Code: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="#gaa3c98f2c275d1ecbafcdba6b6c6032e7">rtc_write</a>(time_t t)</div>
<div class="line">{</div>
<div class="line">    RTC_SECONDS = t;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal__rtc_html_gaa3c98f2c275d1ecbafcdba6b6c6032e7"><div class="ttname"><a href="#gaa3c98f2c275d1ecbafcdba6b6c6032e7">rtc_write</a></div><div class="ttdeci">void rtc_write(time_t t)</div></div>
</div><!-- fragment --> 
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
