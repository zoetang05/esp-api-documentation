<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: Nanostack&#39;s event system.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('group__nanostack-eventloop.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle"><div class="title">Nanostack's event system.</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="eventOS__event_8h.html">eventOS_event.h</a></td></tr>
<tr class="memdesc:eventOS__event_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="classNanostack.html">Nanostack</a>'s event loop. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="eventOS__event__timer_8h.html">eventOS_event_timer.h</a></td></tr>
<tr class="memdesc:eventOS__event__timer_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Functions for sending delayed events. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="eventOS__scheduler_8h.html">eventOS_scheduler.h</a></td></tr>
<tr class="memdesc:eventOS__scheduler_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Event scheduler's control functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Small event scheduler and timer system written in C.</p>
<p>This event system is originating from project called <a class="el" href="classNanostack.html">Nanostack</a> and developed within Arm. Therefore some of the types and names within this library are prefixed with <code>ns_*</code> or <code>arm_*</code> or <code>eventOS*</code>.</p>
<h3>Concept</h3>
<p>Event loop uses a concept called tasklet, which is just a callback function that receives events. There can be as many as 128 tasklets registered if memory allows. This is only limited by event ID being just 8-bits. Each tasklet is first registered to the event system, which then gives 8 bit ID number for the tasklet.</p>
<p>Events are send to a specific tasklet, identified by its ID. Each event is coded into a <a class="el" href="structarm__event__s.html">arm_event_s</a> structure which is then pushed into event loop by calling <a class="el" href="eventOS__event_8h.html#a3d6ccbb5f422c52ca890ec1b58e4f21a" title="Send event to event scheduler.">eventOS_event_send()</a>.</p>
<h3>Usage</h3>
<p>To send or receive events, you first need to register your event handler. </p><div class="fragment"><div class="line"><span class="comment">// In header</span></div>
<div class="line"><span class="keyword">extern</span> uint8_t my_eventhandler_id;</div>
<div class="line"><span class="preprocessor">#define INITIALIZATION_EVENT 0</span></div>
<div class="line"><span class="preprocessor">#define MY_EVENT 1</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// In my_handler.cpp</span></div>
<div class="line"><span class="keywordtype">void</span> my_event_handler(arm_event_t *e)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (e-&gt;<a class="code hl_variable" href="structarm__event__s.html#a7682422d647c1921022122f7f4556b9b">event_type</a>) {</div>
<div class="line">        <span class="keywordflow">case</span> INITIALIZATION_EVENT:</div>
<div class="line">            <span class="comment">// Initialize my module</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> MY_EVENT:</div>
<div class="line">            <span class="comment">// Event received</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Register the handler</span></div>
<div class="line">my_eventhandler_id = eventOS_event_handler_create(my_event_handler, INITIALIZATION_EVENT);</div>
<div class="line"><span class="keywordflow">if</span> (my_eventhandler_id &lt; 0) {</div>
<div class="line">    <span class="comment">// fail</span></div>
<div class="line">}</div>
<div class="ttc" id="astructarm__event__s_html_a7682422d647c1921022122f7f4556b9b"><div class="ttname"><a href="structarm__event__s.html#a7682422d647c1921022122f7f4556b9b">arm_event_s::event_type</a></div><div class="ttdeci">uint8_t event_type</div><div class="ttdef"><b>Definition</b> eventOS_event.h:213</div></div>
</div><!-- fragment --><p>Each event is basically a <a class="el" href="structarm__event__s.html">arm_event_s</a> structure. You need to fill in the <a class="el" href="structarm__event__s.html#a4e1d42917c78c1f74254458ffaabe395">arm_event_s::receiver</a> field. Rest of the fields are optional, and used only by the receiving callback. So you have different options to deliver data to a receiving tasklet. The structure is copied by the event system, so temporary storage may be used, and the structure may be freed after it has been pushed into event system.</p>
<div class="fragment"><div class="line"><span class="comment">// Send the event</span></div>
<div class="line">arm_event_t e = {</div>
<div class="line"> .receiver = my_eventhandler_id,</div>
<div class="line"> .event_type = MY_EVENT</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_function" href="eventOS__event_8h.html#a3d6ccbb5f422c52ca890ec1b58e4f21a">eventOS_event_send</a>(e) != 0) {</div>
<div class="line"> <span class="comment">// fail</span></div>
<div class="line">}</div>
<div class="ttc" id="aeventOS__event_8h_html_a3d6ccbb5f422c52ca890ec1b58e4f21a"><div class="ttname"><a href="eventOS__event_8h.html#a3d6ccbb5f422c52ca890ec1b58e4f21a">eventOS_event_send</a></div><div class="ttdeci">int8_t eventOS_event_send(const arm_event_t *event)</div><div class="ttdoc">Send event to event scheduler.</div><div class="ttdef"><b>Definition</b> event.c:120</div></div>
</div><!-- fragment --><p>Where required, event system allows you to delay the event propagation.</p>
<div class="fragment"><div class="line"><span class="comment">// Wait 3 seconds before the event</span></div>
<div class="line"><span class="preprocessor">#define MY_DELAY_MS 3000</span></div>
<div class="line"> </div>
<div class="line">arm_event_t e = {</div>
<div class="line">    .receiver = my_eventhandler_id,</div>
<div class="line">    .event_type = MY_EVENT</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">uint32_t delay = eventOS_event_timer_ms_to_ticks(MY_DELAY_MS);</div>
<div class="line"><a class="code hl_define" href="eventOS__event_8h.html#abc3fdb6c059494afee1592dc73cdf552">eventOS_event_send_after</a>(e, delay);</div>
<div class="ttc" id="aeventOS__event_8h_html_abc3fdb6c059494afee1592dc73cdf552"><div class="ttname"><a href="eventOS__event_8h.html#abc3fdb6c059494afee1592dc73cdf552">eventOS_event_send_after</a></div><div class="ttdeci">#define eventOS_event_send_after(event, after)</div><div class="ttdef"><b>Definition</b> eventOS_event.h:276</div></div>
</div><!-- fragment --><dl class="section see"><dt>See also</dt><dd><a class="el" href="eventOS__event_8h.html" title="Nanostack&#39;s event loop.">eventOS_event.h</a> </dd>
<dd>
<a class="el" href="eventOS__event_8h.html#a33fbeb152ceba86b0fc096618aaf48ec">eventOS_event_send_at</a> </dd>
<dd>
<a class="el" href="eventOS__event_8h.html#a3e4f3ddbd2bbf4f585fcf8c88e5c509d">eventOS_event_send_in</a> </dd>
<dd>
<a class="el" href="eventOS__event_8h.html#abc3fdb6c059494afee1592dc73cdf552">eventOS_event_send_after</a> </dd>
<dd>
<a class="el" href="eventOS__event_8h.html#a7492466fc7d44d516597f1040634634d">eventOS_event_send_every</a></dd></dl>
<h3>Pre-allocated events</h3>
<p>Two options are provided to limit the heap usage. First option is to use recurring events with <a class="el" href="eventOS__event_8h.html#a7492466fc7d44d516597f1040634634d">eventOS_event_send_every()</a>, so your event is only allocated once. This allows you to create application that does not use heap after initialization phase.</p>
<p>Second option is to use pre-allocated or statically allocated event structure. In this model you create a space for <a class="el" href="structarm__event__storage.html">arm_event_storage</a> structure and send events using <a class="el" href="eventOS__event_8h.html#aa94f2ebc9351855db261df3d1318aa07" title="Send user-allocated event to event scheduler.">eventOS_event_send_user_allocated()</a> call. This is also very robust, as there is no allocation, so the sending of the event will never fail because of lack of memory.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> pending = <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">static</span> arm_event_storage_t e;</div>
<div class="line"><span class="keyword">static</span> int8_t foo_tasklet_id;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> notify_foo()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!pending) {</div>
<div class="line">        pending = <span class="keyword">true</span>;</div>
<div class="line">        e.data.<a class="code hl_variable" href="structarm__event__s.html#a4e1d42917c78c1f74254458ffaabe395">receiver</a> = foo_tasklet_id;</div>
<div class="line">        e.data.type = MY_EVENT;</div>
<div class="line">        <a class="code hl_function" href="eventOS__event_8h.html#aa94f2ebc9351855db261df3d1318aa07">eventOS_event_send_user_allocated</a>(&amp;e);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> foo_event_handler(arm_event_t *e)</div>
<div class="line">{</div>
<div class="line">    pending = <span class="keyword">false</span>;</div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="ttc" id="aeventOS__event_8h_html_aa94f2ebc9351855db261df3d1318aa07"><div class="ttname"><a href="eventOS__event_8h.html#aa94f2ebc9351855db261df3d1318aa07">eventOS_event_send_user_allocated</a></div><div class="ttdeci">void eventOS_event_send_user_allocated(arm_event_storage_t *event)</div><div class="ttdoc">Send user-allocated event to event scheduler.</div><div class="ttdef"><b>Definition</b> event.c:133</div></div>
<div class="ttc" id="astructarm__event__s_html_a4e1d42917c78c1f74254458ffaabe395"><div class="ttname"><a href="structarm__event__s.html#a4e1d42917c78c1f74254458ffaabe395">arm_event_s::receiver</a></div><div class="ttdeci">int8_t receiver</div><div class="ttdef"><b>Definition</b> eventOS_event.h:211</div></div>
</div><!-- fragment --><h3>Initialization</h3>
<p>Event system does not use malloc(), free() or any system heap directly, but uses <a class="el" href="nsdynmemLIB_8h.html" title="Dynamical Memory API for library model nsdynmemlib provides access to one default heap,...">nsdynmemLIB.h</a> library instead. Event system must first be initialized by callind <a class="el" href="eventOS__scheduler_8h.html#aa2e6236d1b059b47a55b5d8a82b527d1" title="Initialise event scheduler.">eventOS_scheduler_init()</a>. This is usually done just after <a class="el" href="nsdynmemLIB_8h.html#ab79bdc69b29c76391bae6a0cc1c79e82" title="Init and set Dynamical heap pointer and length.">ns_dyn_mem_init()</a> call. Where porting is already provided, these both are initialized in function called ns_hal_init().</p>
<p>After initialization, you can start the event loop by calling <a class="el" href="eventOS__scheduler_8h.html#a15c5ff3a2b1d38aa533fba478fb708c7" title="Start Event scheduler. Loops forever processing events from the queue. Calls eventOS_scheduler_idle()...">eventOS_scheduler_run()</a> which will never return. This is usually end of the <code>main()</code> function.</p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> my_event_handler(arm_event_t *e);</div>
<div class="line"><span class="keyword">extern</span> int8_t my_eventhandler_id;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_function" href="nsdynmemLIB_8h.html#ab79bdc69b29c76391bae6a0cc1c79e82">ns_dyn_mem_init</a>(NULL, HEAP_SIZE, NULL, NULL);</div>
<div class="line">    <a class="code hl_function" href="eventOS__scheduler_8h.html#aa2e6236d1b059b47a55b5d8a82b527d1">eventOS_scheduler_init</a>();</div>
<div class="line">    my_eventhandler_id = eventOS_event_handler_create(my_event_handler, INITIALIZATION_EVENT);</div>
<div class="line">    <a class="code hl_function" href="eventOS__scheduler_8h.html#a15c5ff3a2b1d38aa533fba478fb708c7">eventOS_scheduler_run</a>()</div>
<div class="line">}</div>
<div class="ttc" id="aeventOS__scheduler_8h_html_a15c5ff3a2b1d38aa533fba478fb708c7"><div class="ttname"><a href="eventOS__scheduler_8h.html#a15c5ff3a2b1d38aa533fba478fb708c7">eventOS_scheduler_run</a></div><div class="ttdeci">NS_NORETURN void eventOS_scheduler_run(void)</div><div class="ttdoc">Start Event scheduler. Loops forever processing events from the queue. Calls eventOS_scheduler_idle()...</div><div class="ttdef"><b>Definition</b> event.c:366</div></div>
<div class="ttc" id="aeventOS__scheduler_8h_html_aa2e6236d1b059b47a55b5d8a82b527d1"><div class="ttname"><a href="eventOS__scheduler_8h.html#aa2e6236d1b059b47a55b5d8a82b527d1">eventOS_scheduler_init</a></div><div class="ttdeci">void eventOS_scheduler_init(void)</div><div class="ttdoc">Initialise event scheduler.</div><div class="ttdef"><b>Definition</b> event.c:264</div></div>
<div class="ttc" id="ansdynmemLIB_8h_html_ab79bdc69b29c76391bae6a0cc1c79e82"><div class="ttname"><a href="nsdynmemLIB_8h.html#ab79bdc69b29c76391bae6a0cc1c79e82">ns_dyn_mem_init</a></div><div class="ttdeci">void ns_dyn_mem_init(void *heap_ptr, ns_mem_heap_size_t h_size, void(*passed_fptr)(heap_fail_t), mem_stat_t *info_ptr)</div><div class="ttdoc">Init and set Dynamical heap pointer and length.</div><div class="ttdef"><b>Definition</b> nsdynmemLIB.c:109</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
