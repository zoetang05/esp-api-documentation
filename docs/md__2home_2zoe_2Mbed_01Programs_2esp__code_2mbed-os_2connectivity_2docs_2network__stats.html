<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: Network statistics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2zoe_2Mbed_01Programs_2esp__code_2mbed-os_2connectivity_2docs_2network__stats.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Network statistics</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md44"></a></p>
<p>This document discusses data collection from API point of view and impact it causes on existing drivers. Aim is not to cause any changes into existing application APIs or driver APIs.</p>
<p>Another aim is that all statistics data we collect is generic enough that the collector application does not need to know the network protocols that are in use. However, these are IP specific, so we don't consider Non-IP protocols here.</p>
<h1><a class="anchor" id="autotoc_md45"></a>
Network APIs where we are going to monitor the data</h1>
<p><img src="https://s3-us-west-2.amazonaws.com/mbed-os-docs-images/networkstacks.png" alt="" class="inline"/></p>
<p>APIs that consist Mbed OS networking are:</p>
<ul>
<li>Network drivers. May driver APIs exist, see <a href="https://os.mbed.com/docs/v5.10/reference/ip-networking.html">IP networking</a></li>
<li><a href="https://os.mbed.com/docs/v5.10/apis/network-interfaces.html">Network interface</a></li>
<li><a href="https://os.mbed.com/docs/v5.10/apis/network-socket.html">Socket API</a></li>
<li><a href="https://os.mbed.com/docs/v5.10/porting/networkstack.html">NetworkStack</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md46"></a>
Network drivers</h2>
<p><b>May provide data:</b> packet counters and network status. In case of external IP stack could also provide information about sockets.</p>
<p>Some network drivers exist outside of the Mbed OS tree, therefore we will not consider adding any data collection into driver APIs. Causing external drivers to be refactored is a time consuming work and requires too much coordination with partners.</p>
<p>Also, some drivers run external IP stacks through AT command interface making it impossible to collect some of the data, for example packet counters.</p>
<p><b>Conclusion:</b> No changes to drivers and no data collection from driver side.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
NetworkInterface</h2>
<p><b>May provide data:</b> Network status and events when status changes. IP addresses, etc.</p>
<p><code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> is a porting interface for networked drivers that require control API, therefore any API change would impact all network drivers that provide this API. For example all external IP stacks provide this API.</p>
<p>Any change on network state is reflected by the driver that calls the event handler that application can register. Refer to <a href="https://os.mbed.com/docs/v5.10/apis/network-status.html">Network Status</a> from Mbed OS handbook. Problem is that this registering happens on driver side, and the high layer <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> API only provides a dummy implementation. If event based information is required API change is forced to either application side, or driver side.</p>
<p><b>Conclusion:</b> Network status is already provided by <code><a class="el" href="classNetworkInterface.html#a50cbc579ff5ee3bc25a79fc0d562d070">NetworkInterface::get_connection_status()</a></code>. Event would cause API change, so will not be done for 5.11. But there are requests to change the API, so we can do it in 5.12. IP addresses are already provided by <code>NetworkInteface</code> API, so will not be touched by stats API.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
Socket</h2>
<p><b>May provide data:</b> Number of sockets open, connection endpoints, amount of data sent per socket, total amount of data sent, protocol types.</p>
<p>In Mbed OS the <code><a class="el" href="classSocket.html">Socket</a></code> is a abstract interface that follows the POSIX <a class="el" href="classSocket.html">Socket</a> API. Any type of sockets can be created by inheriting the base class. But Mbed OS internally knows only two type of sockets, TCP and UDP, and those share the same base class <code><a class="el" href="classInternetSocket.html">InternetSocket</a></code>. Basically all data that device is able to send to network flows through these three classes <code><a class="el" href="classInternetSocket.html">InternetSocket</a></code>, <code><a class="el" href="classTCPSocket.html">TCPSocket</a></code> and <code><a class="el" href="classUDPSocket.html">UDPSocket</a></code>.</p>
<p>Sockets can be constructed and destructed on the fly, so the data collected should be stored elsewhere.</p>
<p><b>Conclusion:</b> We can either collect one cumulative number of all data send through sockets, or numbers per opened socket, endpoint or port number. Or we can provide list of sockets currently active in the system.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
NetworkStack</h2>
<p><b>May provide data:</b> Same as <a class="el" href="classSocket.html">Socket</a></p>
<p><code><a class="el" href="classNetworkStack.html">NetworkStack</a></code> is a porting layer for a driver that provides a socket API. Each stack provides <code>struct <a class="el" href="structnsapi__stack__api.html">nsapi_stack_api</a></code> which contains all functions that Mbed OS <a class="el" href="classSocket.html">Socket</a> API calls.</p>
<p><b>Conclusion:</b> Same data can be collected from <code><a class="el" href="classInternetSocket.html">InternetSocket</a></code> class so we will not touch the porting layer.</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Data collection API</h1>
<p>This is proposal of the new API that provides network statistics. Some parts can be done in Mbed OS 5.11 timeframe without API changes. I'll also propose API changes for 5.12 to collect more data.</p>
<h2><a class="anchor" id="autotoc_md51"></a>
Socket status list</h2>
<p>We could show some kind of list of sockets that are currently open, or have been open. Instead of abstract ID, we provide pointers to the <code><a class="el" href="classSocket.html">Socket</a></code> objects, we those pointers are not thread safe, because the original object might already been desctructed when data is parsed. Therefore the last associated destination address is copied into this structure. Or if we want to save memory, we could record just the destination port number.</p>
<div class="fragment"><div class="line">typedef enum socket_state {</div>
<div class="line">    CLOSED,                         /**&lt; Socket is closed and does not exist anymore in the system */</div>
<div class="line">    OPEN,                           /**&lt; Socket is open, but not associated to any peer address */</div>
<div class="line">    CONNECTED,                      /**&lt; Socket is associated to peer address, either by connect() or sendto()/recvfrom() calls */</div>
<div class="line">    LISTEN,                         /**&lt; Socket is listening for incoming connections */</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">typedef struct {</div>
<div class="line">    Socket *socket;                 /**&lt; Pointer to original Socket objet. Not safe to access, used for identifying */</div>
<div class="line">    SocketAddress peername          /**&lt; Last associated peername of this socket (Destination address) */</div>
<div class="line">    socket_state state;             /**&lt; State of this socket */</div>
<div class="line">    uint32_t tick_last_change;      /**&lt; osKernelGetTick() when state last changed */</div>
<div class="line">    size_t sent;                    /**&lt; Data sent through this socket */</div>
<div class="line">    size_t received;                /**&lt; Data received through this socket */</div>
<div class="line">} mbed_stats_socket_t</div>
<div class="line"> </div>
<div class="line">/** Write socket statistics into structure pointed by stats.</div>
<div class="line">  * @count How many structures can be written</div>
<div class="line">  * @return How many structures was written</div>
<div class="line">  */</div>
<div class="line">size_t mbed_stats_socket_get_each(mbed_stats_thread_t *stats, size_t count);</div>
</div><!-- fragment --><p>RAM requirement <code>sizeof(SocketAddress) + sizeof(Socket*) + sizeof(enum) + sizeof(uint32_t)*3=26+4+4+4*3 = 46</code> per socket stats. How many we keep in memory? 10?</p>
<h2><a class="anchor" id="autotoc_md52"></a>
Network status events (For Mbed OS 5.12)</h2>
<p>Because in the future, the event handler needs API changes anyway, as requested in <a href="https://jira.arm.com/browse/ONME-3917">ONME-3917</a> we can then consider adding statistics collection into status events. This would be done so that <code><a class="el" href="classNetworkInterface.html">NetworkInterface</a></code> would be a wrapper between user callbacks and callbacks coming from the driver.</p>
<p>Status events should capture system timestamp associated with the events. API is similar to some in <code><a class="el" href="mbed__stats_8h_source.html">mbed_stats.h</a></code> that requests array of events. Internally the stats should have some cap of how many events can be kept in memory. Perhaps configurable?</p>
<div class="fragment"><div class="line">typedef struct {</div>
<div class="line">    uint32_t tick;                   /**&lt; osKernelGetTick() value of when event happened, or equivalent timestamp */</div>
<div class="line">    NetworkInteface *interface;      /**&lt; What interface caused this event */</div>
<div class="line">    nsapi_connection_status_t status /**&lt; What was the event */</div>
<div class="line">} mbed_stats_connection_t;</div>
<div class="line"> </div>
<div class="line">/** Write network connection statistics into structure pointed by stats.</div>
<div class="line">  * @count How many structures can be written</div>
<div class="line">  * @return How many structures was written</div>
<div class="line">  */</div>
<div class="line">size_t mbed_stats_connection_get_each(mbed_stats_thread_t *stats, size_t count);</div>
</div><!-- fragment --><p>RAM requirements <code>4 * 3 = 12</code> per how many statuses we keep in memory.</p>
<h1><a class="anchor" id="autotoc_md53"></a>
Examples of what can we collect after these changes</h1>
<p>This is not a full list.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Data   </th><th class="markdownTableHeadNone">Where to get it?    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">State of each network interface   </td><td class="markdownTableBodyNone"><code><a class="el" href="classNetworkInterface.html#a50cbc579ff5ee3bc25a79fc0d562d070">NetworkInterface::get_connection_status()</a></code> and <code>mbed_stats_connection_t.status</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">How many network interfaces have been created   </td><td class="markdownTableBodyNone">return value of <code>mbed_stats_connection_get_each()</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">What is the IP address of each interface   </td><td class="markdownTableBodyNone"><code><a class="el" href="classNetworkInterface.html#a3caf98844ea0d3a19b2fe7648536be25">NetworkInterface::get_ip_address()</a></code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MAC address of each interface   </td><td class="markdownTableBodyNone"><code><a class="el" href="classNetworkInterface.html#a44e9c420561d0a7e213440b758dd9105">NetworkInterface::get_mac_address()</a></code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">How many sockets have been used   </td><td class="markdownTableBodyNone"><code>mbed_stats_network_t.udp_sockets + mbed_stats_network_t.tcp_sockets</code>   </td></tr>
</table>
<p>|How many sockets are used now|Count each <code><a class="el" href="structmbed__stats__socket__t.html#a4cf056644c9900903c89a2bc00cb32ef">mbed_stats_socket_t.state</a> == OPEN||CONNECTED</code>| |Where did we send data?|Check each <code>mbed_stats_socket_t.peername</code>| |How much did we send data to that target|Check each <code>mbed_stats_socket_t.sent</code> where <code>peername == target</code>| |What happened to sockets after network lost|Check <code>mbed_stats_connection_t.tick</code> and compare to <code>mbed_stats_socket_t.tick_last_change</code>| </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
