<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: Creating components with CMake</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2zoe_2Mbed_01Programs_2esp__code_2mbed-os_2docs_2design-documents_2tools_2cmake__components.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Creating components with CMake</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md608"></a></p>
<p>One of the main goals to achieve with CMake is to have components in Mbed OS. A modular built allowing users to select what they require, not building everything as we used to with old tools.</p>
<h1><a class="anchor" id="autotoc_md609"></a>
Components in Mbed OS (bare-metal)</h1>
<p>Mbed OS consist of:</p><ul>
<li>cmsis</li>
<li>rtos-api</li>
<li>drivers</li>
<li>platform</li>
<li>hal</li>
<li>targets</li>
</ul>
<p>Their dependencies:</p>
<p>cmsis: None</p>
<p>drivers:</p><ul>
<li>platform</li>
<li>rtos-api</li>
<li>hal</li>
<li>targets</li>
<li>events</li>
</ul>
<p>rtos-api:</p><ul>
<li>targets</li>
<li>platform</li>
</ul>
<p>platform:</p><ul>
<li>rtos-api</li>
<li>hal</li>
<li>targets</li>
</ul>
<p>hal:</p><ul>
<li>targets</li>
</ul>
<p>targets:</p><ul>
<li>hal</li>
<li>drivers</li>
<li>platform</li>
<li>rtos-api</li>
<li>cmsis</li>
</ul>
<p>Breaking the dependencies would be a huge effort and it possibly would result in rewriting these components as they were for years considered as monolitic - having everything available.</p>
<h1><a class="anchor" id="autotoc_md610"></a>
Components as object libraries</h1>
<p>CMake provides OBJECT libraries but it does not support circular dependencies that we have in our tree. Therefore we build Mbed OS as whole (all object files combined).</p>
<h1><a class="anchor" id="autotoc_md611"></a>
One object library "mbed-core"</h1>
<p>Our current approach on feature-cmake branch is to use OBJECT libraries. We built almost entire tree of Mbed OS, the number of object files is big. As result building take longer and we have again windows path limitation (one file compilation command is more than 43k characters long).</p>
<p>To address the problem, CMake provides response files. They do not work out of the box as we experienced. Generators support them but they contain bugs. We found at least two bugs in CMake itself (Ninja, Make tested with Gcc Arm and ARMClang). We are still possibly having issues with other generators (more testing is required).</p>
<p>Note, we shall use response files with static libraries or any other solution we choose to avoid path limitation in OS.</p>
<p>These bugs will be fixed eventually. However, we still have not addressed the main problem - there are too many objects files to compile. We need a solution to split the tree into components and built only what is required. Therefore response files could be considered as a workaround for now until we get components in CMake.</p>
<h1><a class="anchor" id="autotoc_md612"></a>
Only core libraries built as objects</h1>
<p>These components would form mbed-core library built as OBJECT library in CMake:</p><ul>
<li>cmsis</li>
<li>events</li>
<li>rtos-api</li>
<li>drivers</li>
<li>hal</li>
<li>targets</li>
<li>platform</li>
</ul>
<p>The rest of components and features could be static or object libraries. They could be selected by a user and be added on request.</p>
<h1><a class="anchor" id="autotoc_md613"></a>
Components as static libraries</h1>
<p>It is a known problem that weakly linked symbols are not resolved with strong symbols with static libraries. We won't disallow linking with static libraries, just internal Mbed OS components should be object libraries to avoid the problem with weakly symbols as many of the components rely on them.</p>
<h2><a class="anchor" id="autotoc_md614"></a>
Using whole-archive to workaround weak symbols limitation</h2>
<p>Toolchains provide a flag to enforce keeping symbols (GCC &ndash;whole-archive, clang -force_load). See the issue with forcing linker flag to the components <a href="https://github.com/zephyrproject-rtos/zephyr/issues/8441">https://github.com/zephyrproject-rtos/zephyr/issues/8441</a> and <a href="https://github.com/zephyrproject-rtos/zephyr/issues/6961">https://github.com/zephyrproject-rtos/zephyr/issues/6961</a> for details. This has drawbacks that will need more research. See also CMake issue <a href="https://gitlab.kitware.com/cmake/cmake/-/issues/20078">https://gitlab.kitware.com/cmake/cmake/-/issues/20078</a> - not simple to fix in CMake.</p>
<p><code>whole-archive</code> is only available to Gcc Arm, ARMClang does not provide it.</p>
<h2><a class="anchor" id="autotoc_md615"></a>
Removing weak symbols</h2>
<p>We could find alternative to weak symbols and fix them in our tree one by one. It was already achieved in Mbed OS 3 where we did not support weak symbols.</p>
<h2><a class="anchor" id="autotoc_md616"></a>
Object files for files with weak symbols</h2>
<p>Mbed 2 was released as a library, we provided object files for files that were providing weak symbols (retarget, file handling and others). They were linked together with the mbed library. This however might not be achievable (its implementation in CMake might contain hacks to get other components paths and flags as retarget file depends on multiple other components).</p>
<h1><a class="anchor" id="autotoc_md617"></a>
External components</h1>
<p>They can be either object or static library. Only one limitation due to selecting object library is that any component linked by an application shall not have circular dependencies between the components (CMake will issue an error that we are linking with an object library (<code>mbed-core</code>) and it does not support it - this will be fixed but no ETA given).</p>
<h1><a class="anchor" id="autotoc_md618"></a>
Solution: Mbed-os components</h1>
<p>mbed-core component (object library) consists of:</p><ul>
<li>cmsis</li>
<li>events</li>
<li>rtos-api</li>
<li>drivers</li>
<li>hal</li>
<li>targets</li>
<li>platform</li>
</ul>
<p>The rest of the tree is formed by components.</p>
<p>Each component creates a new CMake library and adds includes/sources:</p>
<div class="fragment"><div class="line">add_library(mbed-nanostack INTERFACE)</div>
<div class="line"> </div>
<div class="line">target_include_directories(mbed-nanostack </div>
<div class="line">    INTERFACE</div>
<div class="line">        include</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">target_sources(mbed-nanostack </div>
<div class="line">    INTERFACE</div>
<div class="line">        file.c</div>
<div class="line">)</div>
</div><!-- fragment --><p>If there are dependencies for a component, use <code>target_link_libraries</code>. For instance, nanostack depends on 4 other components:</p>
<div class="fragment"><div class="line">target_link_libraries(mbed-nanostack INTERFACE mbed-nanostack-libservice mbed-netsocket mbed-coap)</div>
</div><!-- fragment --><p>An application just links to what is required:</p>
<div class="fragment"><div class="line">target_link_libraries(mbed-os-example-nanostack-example mbed-nanostack mbed-core)</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
