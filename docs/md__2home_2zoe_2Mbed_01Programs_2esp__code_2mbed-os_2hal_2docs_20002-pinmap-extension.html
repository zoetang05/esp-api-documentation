<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: HAL PinMap design document</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2zoe_2Mbed_01Programs_2esp__code_2mbed-os_2hal_2docs_20002-pinmap-extension.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">HAL PinMap design document</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md729"></a></p>
<h1><a class="anchor" id="autotoc_md730"></a>
Table of contents</h1>
<ol type="1">
<li>HAL PinMap design document.</li>
</ol>
<ol type="1">
<li>Table of contents.</li>
</ol>
<ol type="1">
<li>Introduction.<ol type="a">
<li>Overview and background.</li>
</ol>
<ol type="a">
<li>Requirements and assumptions.</li>
</ol>
</li>
</ol>
<ol type="1">
<li>System architecture and high-level design.<ol type="a">
<li>Pinmap.</li>
</ol>
<ol type="a">
<li>Form Factor.</li>
</ol>
<ol type="a">
<li>Restricted Pins.</li>
</ol>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md731"></a>
Introduction</h1>
<p>Adds board introspection capabilities and tools. <br  />
 These tools will help designing better tests for the HAL.</p>
<h3><a class="anchor" id="autotoc_md732"></a>
Overview and background</h3>
<p>At the time being, drivers are only tested on a single "default" peripheral. However, some targets feature the same peripheral through different blocks' implementations for example the SPI may be provided on a single MCU by its USART, QSPI and SSP peripherals. To ensure that the driver's implementation is valid for all these peripherals we want the CI to run the test set on each peripheral using at least one set of pin determined at run time (pin may eventually picked randomly).</p>
<h3><a class="anchor" id="autotoc_md733"></a>
Requirements and assumptions</h3>
<ol type="1">
<li>We want to list all pins for a function on a peripheral. For instance, all pins that can be configured as MOSI for SPI1.</li>
<li>We want to list all functions a pin can provide.</li>
<li>We want to list all pins for a form-factor regardless of the function they can provide.</li>
<li>We want a printable name for each form factor pin and a method to get that name.</li>
<li>We want a list of the reserved pins that cannot be tested.</li>
</ol>
<p>Any of the list mentioned above may be empty if none match the criteria.</p>
<h1><a class="anchor" id="autotoc_md734"></a>
System architecture and high-level design</h1>
<h3><a class="anchor" id="autotoc_md735"></a>
Pinmap</h3>
<p>All HAL APIs which use pins have functions to get the corresponding pin maps. These functions return a <code><a class="el" href="structPinMap.html">PinMap</a></code> array with each entry containing a pin name, a peripheral and a function. The end of the pin map array is indicated by the presence of a NC pin. Below is an example implementation of the function to get the serial tx pinmap:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="structPinMap.html">PinMap</a> PinMap_UART_TX[] = {</div>
<div class="line">    {P0_19, UART_0, 1},</div>
<div class="line">    {P1_13, UART_0, 3},</div>
<div class="line">    {P1_27, UART_0, 2},</div>
<div class="line">    { NC  , NC    , 0}</div>
<div class="line">};</div>
<div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="structPinMap.html">PinMap</a> *serial_tx_pinmap()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> PinMap_UART_TX;</div>
<div class="line">}</div>
<div class="ttc" id="astructPinMap_html"><div class="ttname"><a href="structPinMap.html">PinMap</a></div><div class="ttdef"><b>Definition</b> pinmap.h:31</div></div>
</div><!-- fragment --><p>Targets which don't make use of a pinmap, such as ones with peripherals that can be connected to any pin, must still define pinmaps as these are needed for testing. For these devices the pinmap does not need to be comprehensive. Instead it should list a representative sample of pins and peripherals so they can be tested appropriately.</p>
<h3><a class="anchor" id="autotoc_md736"></a>
Form Factor</h3>
<p>A boards form factor determines what can be tested automatically. A board can have one or more form factors, each listed in the <code>supported_form_factors</code> entry in targets.json:</p>
<div class="fragment"><div class="line">&quot;supported_form_factors&quot;: [&quot;ARDUINO&quot;],</div>
</div><!-- fragment --><p>The Mbed pinamp code has built in support for common form factors, such as <code>ARDUINO</code>. When a known form factor is present in the <code>supported_form_factors</code> list then it will be used automatically for testing. Use the target configuration value <code>default-form-factor</code> to test a custom form factor or to force the tools to use a given form factor.</p>
<p>Use the function <code>const <a class="el" href="structPinList.html">PinList</a> *pinmap_ff_default_pins(void)</code> to get the pins of a form factor for testing. Additionally the name of a given form factor pin can be found with the function <code>const char *pinmap_ff_default_pin_to_string(PinName pin)</code>.</p>
<h3><a class="anchor" id="autotoc_md737"></a>
Restricted Pins</h3>
<p>Some boards have pins which cannot be tested without causing problems elsewhere. One example of this is the serial TX and RX pins used for communication during testing. If these pins are used during a test then communication with the host PC will be lost. To prevent pins like this from being used a target can override the weak function <code><a class="el" href="group__hal.html#ga7ae9bbf0c2ebac1a1baf216f7e29a626">pinmap_restricted_pins()</a></code> to return a pin list containing all target pins which should be skipped during testing. By default this function only includes the TX and RX pins used for communication during testing:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="group__platform__toolchain.html#gaa7bb5d6a31c6888e54eea75c60f06400">MBED_WEAK</a> <span class="keyword">const</span> <a class="code hl_struct" href="structPinList.html">PinList</a> *<a class="code hl_function" href="group__hal.html#ga7ae9bbf0c2ebac1a1baf216f7e29a626">pinmap_restricted_pins</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> PinName pins[] = {</div>
<div class="line">        CONSOLE_TX, CONSOLE_RX</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <a class="code hl_struct" href="structPinList.html">PinList</a> pin_list = {</div>
<div class="line">        <span class="keyword">sizeof</span>(pins) / <span class="keyword">sizeof</span>(pins[0]),</div>
<div class="line">        pins</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordflow">return</span> &amp;pin_list;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__hal_html_ga7ae9bbf0c2ebac1a1baf216f7e29a626"><div class="ttname"><a href="group__hal.html#ga7ae9bbf0c2ebac1a1baf216f7e29a626">pinmap_restricted_pins</a></div><div class="ttdeci">const PinList * pinmap_restricted_pins(void)</div><div class="ttdef"><b>Definition</b> mbed_pinmap_default.cpp:70</div></div>
<div class="ttc" id="agroup__platform__toolchain_html_gaa7bb5d6a31c6888e54eea75c60f06400"><div class="ttname"><a href="group__platform__toolchain.html#gaa7bb5d6a31c6888e54eea75c60f06400">MBED_WEAK</a></div><div class="ttdeci">#define MBED_WEAK</div><div class="ttdef"><b>Definition</b> mbed_toolchain.h:171</div></div>
<div class="ttc" id="astructPinList_html"><div class="ttname"><a href="structPinList.html">PinList</a></div><div class="ttdef"><b>Definition</b> pinmap.h:37</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
