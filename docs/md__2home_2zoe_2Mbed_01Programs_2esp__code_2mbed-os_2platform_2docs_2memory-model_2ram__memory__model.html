<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: RAM memory model update - Mbed OS</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2zoe_2Mbed_01Programs_2esp__code_2mbed-os_2platform_2docs_2memory-model_2ram__memory__model.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">RAM memory model update - Mbed OS</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md819"></a></p>
<h1><a class="anchor" id="autotoc_md820"></a>
Table of contents</h1>
<ol type="1">
<li>RAM memory model update - Mbed OS.</li>
</ol>
<ol type="1">
<li>Table of contents.<ol type="a">
<li>Revision history.</li>
</ol>
</li>
</ol>
<ol type="1">
<li>Introduction.<ol type="a">
<li>Current RAM memory model.</li>
</ol>
<ol type="a">
<li>Proposed RAM memory model.</li>
</ol>
</li>
</ol>
<ol type="1">
<li>Phases.</li>
</ol>
<ol type="1">
<li>Detailed Design (#detailed-design).</li>
</ol>
<ol type="1">
<li>Tools and configuration changes.</li>
</ol>
<h3><a class="anchor" id="autotoc_md821"></a>
Revision history</h3>
<p>1.0 - A brief description of this version. For example, Initial revision - Author name - Date. <b>NOTE: You may also specify the Mbed OS version this revision of design document applies to.</b> 1.1 - Added new section - Author name - Date.</p>
<h1><a class="anchor" id="autotoc_md822"></a>
Introduction</h1>
<h3><a class="anchor" id="autotoc_md823"></a>
Current RAM memory model</h3>
<p>Single memory space is shared between stack and heap memory, start address is fixed but the size of both regions varies based on application and usage runtime. Heap starts at the first address after the end of ZI growing up into higher memory address and stack starts at the last memory address of RAM growing downward into lower addresses. </p><pre class="fragment">            +----------------------+ Stack Start (Last address of RAM)
            | ISR stack            |
            | Main Stack(No RTOS)  |
            |          |           |
            |          V           |
            +----------------------+
            |          ^           |
            |          |           |
            |        Heap          |
            +----------------------+ HEAP Start
            |         ZI           |
            |(Idle, Timer and Main |
            | stack is in ZI for   |
            | RTOS)                |
            +----------------------+
            |                      |
            +----------------------+ First address of RAM
</pre><h4><a class="anchor" id="autotoc_md824"></a>
Drawbacks:</h4>
<ol type="1">
<li>Collisions between stack and heap are hard to detect and result in hardfault.</li>
</ol>
<ol type="1">
<li>Cannot check stack limit - In case of new ARM architecture stack limit registers are available to verify stack boundaries, but this feature cannot be used with dynamic stack size.</li>
</ol>
<ol type="1">
<li>Stack size unification cannot be achieved across various targets.</li>
</ol>
<ol type="1">
<li>GCC ARM: Memory allocator request memory at 4K boundary end of HEAP memory should be 4K aligned. Placing ISR stack (1K) after HEAP memory in case of RTOS, results in loss of 3K RAM memory</li>
</ol>
<ol type="1">
<li>Memory allocators do not support HEAP split into multiple banks, hence with single region memory model HEAP is used only till end of first bank.</li>
</ol>
<h3><a class="anchor" id="autotoc_md825"></a>
Proposed RAM memory model</h3>
<p>2-region memory model for heap and stack. Defined boundaries for ISR stack memory. Heap memory can be dynamic (starts at end of ZI and ends at last RAM address) or with fix boundaries in separate RAM bank. </p><pre class="fragment">            +----------------------+ Heap Ends (Last address of RAM)
            |          ^           |
            |          |           |
            |        Heap          |
            +----------------------+ HEAP Start
            |         ZI           |
            |(Idle, Timer and Main |
            | stack is in ZI for   |
            | RTOS)                |
            +----------------------+Stack Ends 
            | ISR stack            |
            | Main Stack(No RTOS)  |
            |          |           |
            |          V           |
            +----------------------+Stack Start
            |                      |
            +----------------------+ First address of RAM
</pre><h4><a class="anchor" id="autotoc_md826"></a>
Drawbacks:</h4>
<ol type="1">
<li>ISR Stack is not dynamic - This drawback is mainly for bare metal implementation (RTOS-less) where ISR and Main stack is same. With this limitation application writer should know if stack or heap will be usued more and tweaks the values accordingly.</li>
</ol>
<h1><a class="anchor" id="autotoc_md827"></a>
Phases:</h1>
<p>This feature will be implemented in different phases as follow:</p>
<p>Phase 1 (5.12 Release):</p><ol type="1">
<li>Adopt 2-region memory model for Stack and Heap memory.</li>
</ol>
<ol type="1">
<li>Unify the stack size across all targets (RTOS: ISR stack - 1K Main thread Stack - 4K; Bare Metal(No RTOS) ISR/Main Stack - 4K)</li>
</ol>
<p>Phase 2:</p><ol type="1">
<li>Heap memory to be dynamic and starts at the end of ZI growing up till end of RAM memory (In case of single RAM bank) Heap memory to be dynamic and assigned partial or full RAM bank in case of multiple RAM banks, based on calculation of other RAM regions.</li>
</ol>
<ol type="1">
<li>ISR Stack to be placed after vectors or before ZI memory section.</li>
</ol>
<p>Note: Heap split support across multiple RAM banks, can also be achieved post this change.</p>
<h1><a class="anchor" id="autotoc_md828"></a>
Detailed Design</h1>
<ol type="1">
<li>Update tools to set define <code>MBED_CONF_TARGET_BOOT_STACK_SIZE</code> from target config option <code>target.boot-stack-size</code></li>
</ol>
<ol type="1">
<li>Linker Scripts - Update linker scripts for ARM, IAR and GCC toolchain to use MBED_CONF_TARGET_BOOT_STACK_SIZE define for standardizing size of ISR stack.</li>
</ol>
<ol type="1">
<li>Update __user_setup_stackheap() implementation to adopt 2-region RAM memory model. __user_setup_stackheap() works with systems where the application starts with a value of sp (r13) that is already correct. To make use of sp(stack base), implement __user_setup_stackheap() to set up r0 (heap base), r2 (heap limit), and r3 (stack limit) (for a two-region model) and return. Reference <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.kui0099a/armlib_cjagaaha.htm">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.kui0099a/armlib_cjagaaha.htm</a> <a href="http://www.keil.com/support/man/docs/armlib/armlib_chr1359122863069.htm">http://www.keil.com/support/man/docs/armlib/armlib_chr1359122863069.htm</a></li>
</ol>
<ol type="1">
<li>Modify _sbrk() implementation for GCC to use 2-region memory model</li>
</ol>
<h1><a class="anchor" id="autotoc_md829"></a>
Tools and configuration changes</h1>
<ol type="1">
<li>Target config option "target.boot-stack-size" which is passed to the linker as the define "MBED_CONF_TARGET_BOOT_STACK_SIZE" so the linker can adjust the stack accordingly. Boot stack size - the size of ISR and main stack will be 4K as default in targets.json for bare metal (non-RTOS) builds. Boot stack size - the size of ISR stack will be over-written as 1K in <code>rtos/mbed_lib.json</code> for RTOS builds. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
