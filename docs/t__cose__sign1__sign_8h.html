<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP API: /home/zoe/Mbed Programs/esp_code/mbed-os/platform/FEATURE_EXPERIMENTAL_API/FEATURE_PSA/TARGET_MBED_PSA_SRV/services/attestation/tfm_impl/t_cose/inc/t_cose_sign1_sign.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('t__cose__sign1__sign_8h.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">t_cose_sign1_sign.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Create a <code>COSE_Sign1</code>, usually for EAT or CWT Token.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &quot;<a class="el" href="qcbor_8h_source.html">qcbor.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="t__cose__common_8h_source.html">t_cose_common.h</a>&quot;</code><br />
</div>
<p><a href="t__cose__sign1__sign_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structt__cose__sign1__ctx.html">t_cose_sign1_ctx</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:af0620e96f053a93cf2691139c8242031" id="r_af0620e96f053a93cf2691139c8242031"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#af0620e96f053a93cf2691139c8242031">t_cose_sign1_init</a> (struct <a class="el" href="structt__cose__sign1__ctx.html">t_cose_sign1_ctx</a> *me, bool short_circuit_sign, int32_t cose_algorithm_id, int32_t key_select, <a class="el" href="qcbor_8h.html#a11844421eac8fb31c92a3a20a458aef5">QCBOREncodeContext</a> *cbor_encode_ctx)</td></tr>
<tr class="memdesc:af0620e96f053a93cf2691139c8242031"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize to start creating a <code>COSE_Sign1</code>.  <br /></td></tr>
<tr class="separator:af0620e96f053a93cf2691139c8242031"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a58e9897856fbd2445d24a879630ce53e" id="r_a58e9897856fbd2445d24a879630ce53e"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a58e9897856fbd2445d24a879630ce53e">t_cose_sign1_finish</a> (struct <a class="el" href="structt__cose__sign1__ctx.html">t_cose_sign1_ctx</a> *me, struct <a class="el" href="structuseful__buf__c.html">useful_buf_c</a> payload)</td></tr>
<tr class="memdesc:a58e9897856fbd2445d24a879630ce53e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Finish creation of the <code>COSE_Sign1</code>.  <br /></td></tr>
<tr class="separator:a58e9897856fbd2445d24a879630ce53e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Create a <code>COSE_Sign1</code>, usually for EAT or CWT Token. </p>
<p>This creates a <code>COSE_Sign1</code> in compliance with [COSE (RFC 8152)] (<a href="https://tools.ietf.org/html/rfc8152">https://tools.ietf.org/html/rfc8152</a>). A <code>COSE_Sign1</code> is a CBOR encoded binary blob that contains headers, a payload and a signature. Usually the signature is made with an EC signing algorithm like ECDSA.</p>
<p>This implementation is intended to be small and portable to different OS's and platforms. Its dependencies are:</p><ul>
<li>QCBOR</li>
<li>&lt;stdint.h&gt;, &lt;string.h&gt;, &lt;stddef.h&gt;</li>
<li>Hash functions like SHA-256</li>
<li>Signing functions like ECDSA</li>
</ul>
<p>There is a cryptographic adaptation layer defined in <a class="el" href="t__cose__crypto_8h.html" title="This is the adaptation layer for cryptographic functions used by t_cose.">t_cose_crypto.h</a>. An implementation can be made of the functions in it for different platforms or OS's. This means that different platforms and OS's may support only signing with a particular set of algorithms.</p>
<p>This <code>COSE_Sign1</code> implementations is optimized for creating EAT tokens.</p>
<p>It should work for CWT and others use cases too. The main point of the optimization is that only one output buffer is needed. There is no need for one buffer to hold the payload and another to hold the end result <code>COSE_Sign1</code>. The payload is encoded right into its final place in the end result <code>COSE_Sign1</code>. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a58e9897856fbd2445d24a879630ce53e" name="a58e9897856fbd2445d24a879630ce53e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a58e9897856fbd2445d24a879630ce53e">&#9670;&#160;</a></span>t_cose_sign1_finish()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign1_finish </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign1__ctx.html">t_cose_sign1_ctx</a> *</td>          <td class="paramname"><span class="paramname"><em>me</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structuseful__buf__c.html">useful_buf_c</a></td>          <td class="paramname"><span class="paramname"><em>payload</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Finish creation of the <code>COSE_Sign1</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">me</td><td>The t_cose signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload</td><td>The pointer and length of the payload.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>Call this to complete creation of a signed token started with <a class="el" href="#af0620e96f053a93cf2691139c8242031" title="Initialize to start creating a COSE_Sign1.">t_cose_sign1_init()</a>.</p>
<p>This is when the signature algorithm is run.</p>
<p>The payload parameter is used only to compute the hash for signing. The completed <code>COSE_Sign1</code> is retrieved from the <code>cbor_encode_ctx</code> by calling <code><a class="el" href="qcbor_8h.html#ac0498cefe2cb8d1454340cc8f68cb75f" title="Get the encoded result.">QCBOREncode_Finish()</a></code> </p>

</div>
</div>
<a id="af0620e96f053a93cf2691139c8242031" name="af0620e96f053a93cf2691139c8242031"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af0620e96f053a93cf2691139c8242031">&#9670;&#160;</a></span>t_cose_sign1_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign1_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign1__ctx.html">t_cose_sign1_ctx</a> *</td>          <td class="paramname"><span class="paramname"><em>me</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool</td>          <td class="paramname"><span class="paramname"><em>short_circuit_sign</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t</td>          <td class="paramname"><span class="paramname"><em>cose_algorithm_id</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t</td>          <td class="paramname"><span class="paramname"><em>key_select</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="qcbor_8h.html#a11844421eac8fb31c92a3a20a458aef5">QCBOREncodeContext</a> *</td>          <td class="paramname"><span class="paramname"><em>cbor_encode_ctx</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize to start creating a <code>COSE_Sign1</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">me</td><td>The t_cose signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">short_circuit_sign</td><td><code>true</code> to select special test mode. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cose_algorithm_id</td><td>The algorithm to sign with. The IDs are defined in [COSE (RFC 8152)] (<a href="https://tools.ietf.org/html/rfc8152">https://tools.ietf.org/html/rfc8152</a>) or in the [IANA COSE Registry] (<a href="https://www.iana.org/assignments/cose/cose.xhtml">https://www.iana.org/assignments/cose/cose.xhtml</a>). </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">key_select</td><td>Which signing key to use. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cbor_encode_ctx</td><td>The CBOR encoder context to output to.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>It is possible to use this to compute the exact size of the resulting token so the exact sized buffer can be allocated. To do this initialize the <code>cbor_encode_ctx</code> with <code><a class="el" href="UsefulBuf_8h.html#a05d9f65b59b672ec72153a346ef7cdad">UsefulBufC</a></code> that has a <code>NULL</code> pointer and large length like <code>UINT32_MAX</code>. Then run the normal token creation. The result will have a NULL pointer and the length of the token that would have been created. When this is run like this, the cryptographic functions will not actually run, but the size of their output will be taken into account.</p>
<p>The key selection depends on the platform / OS.</p>
<p>Which signing algorithms are supported depends on the platform/OS. The header file <a class="el" href="t__cose__defines_8h.html" title="Constants from COSE standard and IANA registry.">t_cose_defines.h</a> contains defined constants for some of them. A typical example is <a class="el" href="t__cose__defines_8h.html#a01d4d739517d68996cbed93749c7e6af">COSE_ALGORITHM_ES256</a> which indicates ECDSA with the NIST P-256 curve and SHA-256.</p>
<p>To use this, create a <code><a class="el" href="qcbor_8h.html#a11844421eac8fb31c92a3a20a458aef5">QCBOREncodeContext</a></code> and initialize it with an output buffer big enough to hold the payload and the COSE Sign 1 overhead. This overhead is about 30 bytes plus the size of the signature and the size of the key ID.</p>
<p>After the <code><a class="el" href="qcbor_8h.html#a11844421eac8fb31c92a3a20a458aef5">QCBOREncodeContext</a></code> is initialized, call <a class="el" href="#af0620e96f053a93cf2691139c8242031" title="Initialize to start creating a COSE_Sign1.">t_cose_sign1_init()</a> on it.</p>
<p>Next call <code>QCBOREncode_BstrWrap()</code> to indicate the start of the payload.</p>
<p>Next call various <code>QCBOREncode_Addxxxx()</code> methods to create the payload.</p>
<p>Next call <code>QCBOREncode_CloseBstrWrap()</code> to indicate the end of the payload. This will also return a pointer and length of the payload that gets hashed.</p>
<p>Next call <a class="el" href="#a58e9897856fbd2445d24a879630ce53e" title="Finish creation of the COSE_Sign1.">t_cose_sign1_finish()</a> with the pointer and length of the payload. This will do all the cryptography and complete the COSE Sign1.</p>
<p>Finally, call <code><a class="el" href="qcbor_8h.html#ac0498cefe2cb8d1454340cc8f68cb75f" title="Get the encoded result.">QCBOREncode_Finish()</a></code> to get the pointer and length of the complete token.</p>
<p>This implements a special signing test mode called <em>short</em> <em>circuit</em> <em>signing</em>. This mode is useful when there is no signing key available, perhaps because it has not been provisioned or configured for the particular device. It may also be because the public key cryptographic functions have not been connected up in the cryptographic adaptation layer.</p>
<p>It has no value for security at all. Data signed this way should not be trusted as anyone can sign like this.</p>
<p>In this mode the signature is the hash of that would normally be signed by the public key algorithm. To make the signature the correct size for the particular algorithm instances of the hash are concatenated to pad it out.</p>
<p>This mode is very useful for testing because all the code except the actual signing algorithm is run exactly as it would if a proper signing algorithm was run.</p>
<p>The kid (Key ID) put in the unprotected headers is created as follows. The EC public key is CBOR encoded as a <code>COSE_Key</code> as defined in the COSE standard. That encoded CBOR is then hashed with SHA-256. This is similar to key IDs defined in IETF PKIX, but is based on COSE and CBOR rather than ASN.1. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_5fdebfbd0a4b5643a5e85bf3c8b1558b.html">mbed-os</a></li><li class="navelem"><a class="el" href="dir_d00fafdb9414f6e624fcf4d73ffde065.html">platform</a></li><li class="navelem"><a class="el" href="dir_a72924067aea8bbead751f11070268f4.html">FEATURE_EXPERIMENTAL_API</a></li><li class="navelem"><a class="el" href="dir_007a19531d3d09289f9f9c2cf309e91b.html">FEATURE_PSA</a></li><li class="navelem"><a class="el" href="dir_05e0d8a557d855fa23572451f1c8ea18.html">TARGET_MBED_PSA_SRV</a></li><li class="navelem"><a class="el" href="dir_ca746bf8ecd12d766019f43663efcc0b.html">services</a></li><li class="navelem"><a class="el" href="dir_923835f9769c78775a68e44a6b879543.html">attestation</a></li><li class="navelem"><a class="el" href="dir_7b21a9191e8d2f7f6543909a71e3be35.html">tfm_impl</a></li><li class="navelem"><a class="el" href="dir_a4b7aa45533a9103aefb0614264d6ac4.html">t_cose</a></li><li class="navelem"><a class="el" href="dir_4d2f159325d6eea3f26b87b818d26ec1.html">inc</a></li><li class="navelem"><a class="el" href="t__cose__sign1__sign_8h.html">t_cose_sign1_sign.h</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
